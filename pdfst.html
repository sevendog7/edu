<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Compressor Pro (Dark)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            950: '#0d1117',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #2d3748; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #718096; }
        
        .toggle-checkbox:checked {
            right: 0;
            border-color: #f56565;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #f56565;
        }
        
        /* Loading Animation */
        .loader {
            border-top-color: #f56565;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 h-14 flex items-center px-6 justify-between flex-shrink-0">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-red-500 rounded flex items-center justify-center text-white font-bold text-xs">PDF</div>
            <h1 class="font-semibold text-lg tracking-tight">[byST] Compressor <span class="text-red-500">Pro</span></h1>
        </div>
        <div class="text-xs text-gray-500">Secure Client-side Processing</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left Panel: Main Content & Preview -->
        <main class="flex-1 flex flex-col relative overflow-hidden bg-gray-900">
            
            <!-- Upload / Preview Area -->
            <div class="flex-1 flex items-center justify-center p-6 relative" id="main-area">
                
                <!-- Upload State -->
                <div id="upload-view" class="w-full max-w-xl text-center">
                    <div id="drop-zone" class="border-2 border-dashed border-gray-600 rounded-xl p-12 bg-gray-800/50 hover:bg-gray-800 hover:border-red-500 transition-all cursor-pointer group">
                        <input type="file" id="file-input" class="hidden" accept="application/pdf">
                        <div class="w-20 h-20 bg-gray-700 rounded-full mx-auto flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                            <svg class="w-10 h-10 text-gray-400 group-hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-medium mb-2 text-gray-200">PDF 파일 추가</h3>
                        <p class="text-gray-500 text-sm">또는 여기에 파일을 드래그하세요</p>
                    </div>
                </div>

                <!-- Processing / Result View -->
                <div id="processing-view" class="hidden w-full max-w-md text-center">
                    <div class="bg-gray-800 rounded-xl p-8 shadow-2xl border border-gray-700">
                        <!-- Status Icon -->
                        <div id="status-icon" class="w-16 h-16 mx-auto mb-6 rounded-full bg-gray-700 flex items-center justify-center">
                            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-600 h-10 w-10"></div>
                        </div>
                        
                        <h3 id="process-title" class="text-xl font-bold mb-2">처리 중...</h3>
                        <p id="process-desc" class="text-gray-400 text-sm mb-6">페이지를 분석하고 있습니다</p>

                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-2 overflow-hidden">
                            <div id="progress-bar" class="bg-red-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500">
                            <span id="current-page">0 / 0</span>
                            <span id="progress-percent">0%</span>
                        </div>

                        <!-- Result Actions -->
                        <div id="result-actions" class="hidden mt-8 grid grid-cols-2 gap-3">
                            <button id="download-btn" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-medium transition flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                저장
                            </button>
                            <button id="reset-btn" class="bg-gray-700 hover:bg-gray-600 text-gray-200 py-2 px-4 rounded-lg font-medium transition">
                                처음으로
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Info Bar (Bottom) -->
            <div id="file-info-bar" class="bg-gray-800 h-12 flex items-center px-6 justify-between border-t border-gray-700 hidden">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-sm text-gray-300">
                        <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L14 2.586A2 2 0 0012.586 2H9z" /><path d="M3 8a2 2 0 012-2v10h8a2 2 0 01-2 2H5a2 2 0 01-2-2V8z" /></svg>
                        <span id="filename-display" class="truncate max-w-[200px]">filename.pdf</span>
                    </div>
                    <span class="text-xs px-2 py-0.5 rounded bg-gray-700 text-gray-400" id="filesize-display">0 MB</span>
                </div>
                <div class="text-xs text-gray-500" id="page-count-display">- Pages</div>
            </div>
        </main>

        <!-- Right Panel: Settings -->
        <aside class="w-80 bg-gray-850 border-l border-gray-700 flex flex-col z-10">
            <!-- Compression Presets -->
            <div class="p-6 border-b border-gray-700">
                <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-4">압축 옵션</h2>
                <div class="flex bg-gray-800 rounded-lg p-1 border border-gray-700">
                    <button class="flex-1 py-1.5 text-xs font-medium rounded-md text-gray-400 hover:text-white transition-colors" data-preset="low">낮음</button>
                    <button class="flex-1 py-1.5 text-xs font-medium rounded-md bg-red-500 text-white shadow-sm transition-colors" data-preset="medium">중간</button>
                    <button class="flex-1 py-1.5 text-xs font-medium rounded-md text-gray-400 hover:text-white transition-colors" data-preset="high">높음</button>
                </div>
                <p id="preset-desc" class="text-xs text-gray-500 mt-3 leading-relaxed">
                    DPI 144, 품질 50%를 적용합니다.<br>화면 열람용으로 적합한 표준 설정입니다.
                </p>
            </div>

            <!-- Advanced Settings -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">사용자 지정 설정</h2>
                    <span class="text-xs text-red-500 cursor-pointer hover:underline" id="reset-settings">초기화</span>
                </div>

                <!-- DPI Setting -->
                <div class="mb-6">
                    <label class="block text-sm text-gray-300 mb-2">이미지 압축 해상도</label>
                    <div class="relative">
                        <select id="dpi-select" class="w-full bg-gray-800 border border-gray-600 text-gray-200 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block p-2.5 appearance-none">
                            <option value="72">72 dpi (웹/모바일용, 최소 용량)</option>
                            <option value="96">96 dpi (저해상도)</option>
                            <option value="144" selected>144 dpi (ebook용, 추천)</option>
                            <option value="200">200 dpi (고품질)</option>
                            <option value="300">300 dpi (인쇄용, 최대)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                            <svg class="fill-current h-4 w-4" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Quality Setting (Slider) -->
                <div class="mb-6">
                    <div class="flex justify-between mb-2">
                        <label class="text-sm text-gray-300">이미지 품질 (JPEG)</label>
                        <span id="quality-val" class="text-xs text-red-400 font-bold">50%</span>
                    </div>
                    <input type="range" id="quality-slider" min="10" max="100" value="50" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-red-500">
                </div>

                <div class="space-y-4">
                    <!-- Checkbox Group: Content -->
                    <div>
                        <h3 class="text-xs text-gray-500 font-semibold mb-2">콘텐츠 압축</h3>
                        <label class="flex items-center space-x-3 cursor-pointer group">
                            <input type="checkbox" id="grayscale-check" class="form-checkbox h-4 w-4 text-red-500 bg-gray-800 border-gray-600 rounded focus:ring-red-500 focus:ring-offset-gray-900">
                            <span class="text-sm text-gray-300 group-hover:text-white">흑백으로 변환 (Grayscale)</span>
                        </label>
                    </div>

                    <!-- Checkbox Group: Remove -->
                    <div>
                        <h3 class="text-xs text-gray-500 font-semibold mb-2">삭제된 콘텐츠 압축</h3>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-3 cursor-not-allowed opacity-75" title="이미지 변환 시 자동 적용">
                                <input type="checkbox" checked disabled class="form-checkbox h-4 w-4 text-red-500 bg-gray-800 border-gray-600 rounded">
                                <span class="text-sm text-gray-400">북마크 삭제</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-not-allowed opacity-75" title="이미지 변환 시 자동 적용">
                                <input type="checkbox" checked disabled class="form-checkbox h-4 w-4 text-red-500 bg-gray-800 border-gray-600 rounded">
                                <span class="text-sm text-gray-400">첨부 파일 삭제</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-not-allowed opacity-75" title="이미지 변환 시 자동 적용">
                                <input type="checkbox" checked disabled class="form-checkbox h-4 w-4 text-red-500 bg-gray-800 border-gray-600 rounded">
                                <span class="text-sm text-gray-400">문서 정보 및 메타데이터 삭제</span>
                            </label>
                        </div>
                        <p class="text-[10px] text-gray-600 mt-2">* 이 옵션들은 최적화를 위해 기본 적용됩니다.</p>
                    </div>
                </div>
            </div>

            <!-- Footer Action -->
            <div class="p-6 border-t border-gray-700 bg-gray-850">
                <button id="compress-btn" disabled class="w-full bg-red-600 hover:bg-red-500 disabled:bg-gray-700 disabled:text-gray-500 disabled:cursor-not-allowed text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all flex items-center justify-center gap-2">
                    <span>압축 시작</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                </button>
            </div>
        </aside>

    </div>

    <script>
        // --- State Management ---
        const state = {
            file: null,
            pdfDoc: null,
            compressedBlob: null,
            settings: {
                dpi: 144,
                quality: 0.5,
                grayscale: false
            }
        };

        // --- Elements ---
        const els = {
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            mainArea: document.getElementById('main-area'),
            uploadView: document.getElementById('upload-view'),
            processingView: document.getElementById('processing-view'),
            fileInfoBar: document.getElementById('file-info-bar'),
            filename: document.getElementById('filename-display'),
            filesize: document.getElementById('filesize-display'),
            pagecount: document.getElementById('page-count-display'),
            
            // Settings
            dpiSelect: document.getElementById('dpi-select'),
            qualitySlider: document.getElementById('quality-slider'),
            qualityVal: document.getElementById('quality-val'),
            grayscaleCheck: document.getElementById('grayscale-check'),
            presetButtons: document.querySelectorAll('[data-preset]'),
            presetDesc: document.getElementById('preset-desc'),
            resetSettings: document.getElementById('reset-settings'),
            
            // Actions
            compressBtn: document.getElementById('compress-btn'),
            
            // Process Status
            statusIcon: document.getElementById('status-icon'),
            processTitle: document.getElementById('process-title'),
            processDesc: document.getElementById('process-desc'),
            progressBar: document.getElementById('progress-bar'),
            progressPercent: document.getElementById('progress-percent'),
            currentPage: document.getElementById('current-page'),
            resultActions: document.getElementById('result-actions'),
            downloadBtn: document.getElementById('download-btn'),
            resetBtn: document.getElementById('reset-btn')
        };

        // --- Utils ---
        const formatSize = (bytes) => {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        // --- Event Listeners ---
        
        // 1. File Upload
        els.dropZone.addEventListener('click', () => els.fileInput.click());
        els.dropZone.addEventListener('dragover', (e) => { e.preventDefault(); els.dropZone.classList.add('border-red-500'); });
        els.dropZone.addEventListener('dragleave', () => els.dropZone.classList.remove('border-red-500'));
        els.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            els.dropZone.classList.remove('border-red-500');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        els.fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        async function handleFile(file) {
            if (file.type !== 'application/pdf') return alert('PDF 파일만 가능합니다.');
            
            state.file = file;
            els.filename.textContent = file.name;
            els.filesize.textContent = formatSize(file.size);
            els.fileInfoBar.classList.remove('hidden');
            
            // Activate Button
            els.compressBtn.disabled = false;
            els.compressBtn.textContent = '분석 중...';
            
            // Load PDF for page count
            try {
                const arrayBuffer = await file.arrayBuffer();
                state.pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
                els.pagecount.textContent = `${state.pdfDoc.numPages} Pages`;
                els.compressBtn.textContent = '압축 시작';
            } catch (e) {
                console.error(e);
                alert('파일을 읽는 중 오류가 발생했습니다.');
                resetAll();
            }
        }

        // 2. Settings Interaction
        const presets = {
            high: { dpi: 72, quality: 30, desc: "DPI 72, 품질 30%. 가장 강력한 압축입니다. (화질 저하)" },
            medium: { dpi: 144, quality: 50, desc: "DPI 144, 품질 50%. 화면 열람용 표준 설정입니다." },
            low: { dpi: 200, quality: 80, desc: "DPI 200, 품질 80%. 화질을 최대한 유지합니다." }
        };

        function updateSettingsUI() {
            els.dpiSelect.value = state.settings.dpi;
            els.qualitySlider.value = state.settings.quality * 100;
            els.qualityVal.textContent = `${Math.round(state.settings.quality * 100)}%`;
            els.grayscaleCheck.checked = state.settings.grayscale;
        }

        els.presetButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                // UI Styles
                els.presetButtons.forEach(b => {
                    b.classList.remove('bg-red-500', 'text-white', 'shadow-sm');
                    b.classList.add('text-gray-400', 'hover:text-white');
                });
                btn.classList.remove('text-gray-400', 'hover:text-white');
                btn.classList.add('bg-red-500', 'text-white', 'shadow-sm');

                // Apply Logic
                const key = btn.dataset.preset;
                state.settings.dpi = presets[key].dpi;
                state.settings.quality = presets[key].quality / 100;
                
                els.presetDesc.innerHTML = presets[key].desc.replace(/\./g, '.<br>');
                updateSettingsUI();
            });
        });

        // Manual Controls
        els.dpiSelect.addEventListener('change', (e) => state.settings.dpi = parseInt(e.target.value));
        els.qualitySlider.addEventListener('input', (e) => {
            state.settings.quality = e.target.value / 100;
            els.qualityVal.textContent = `${e.target.value}%`;
            // Reset preset selection style visually if manually changed (optional, keeping simple for now)
        });
        els.grayscaleCheck.addEventListener('change', (e) => state.settings.grayscale = e.target.checked);
        els.resetSettings.addEventListener('click', () => {
             document.querySelector('[data-preset="medium"]').click();
             els.grayscaleCheck.checked = false;
             state.settings.grayscale = false;
        });


        // 3. Compression Process
        els.compressBtn.addEventListener('click', async () => {
            if (!state.file || !state.pdfDoc) return;

            // UI Switch
            els.uploadView.classList.add('hidden');
            els.processingView.classList.remove('hidden');
            els.resultActions.classList.add('hidden');
            
            // Reset Progress
            els.statusIcon.innerHTML = `<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-600 h-10 w-10"></div>`;
            els.processTitle.textContent = "처리 중...";
            els.processDesc.className = "text-gray-400 text-sm mb-6";
            
            // Calculate Scale from DPI
            // PDF Point = 1/72 inch. So DPI 72 = Scale 1.0
            const scale = state.settings.dpi / 72;
            const quality = state.settings.quality;
            const isGrayscale = state.settings.grayscale;

            try {
                const newPdf = new jspdf.jsPDF();
                const totalPages = state.pdfDoc.numPages;
                let isFirstPage = true;

                for (let i = 1; i <= totalPages; i++) {
                    // Update Status
                    const pct = Math.round((i / totalPages) * 100);
                    els.progressBar.style.width = `${pct}%`;
                    els.progressPercent.textContent = `${pct}%`;
                    els.currentPage.textContent = `${i} / ${totalPages}`;

                    // Render
                    const page = await state.pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: scale });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    // Grayscale filter
                    if (isGrayscale) {
                        context.filter = 'grayscale(100%)';
                    }

                    await page.render({ canvasContext: context, viewport: viewport }).promise;

                    // Compress to JPEG
                    const imgData = canvas.toDataURL('image/jpeg', quality);
                    
                    // Add to PDF
                    const imgProps = newPdf.getImageProperties(imgData);
                    const pdfWidth = newPdf.internal.pageSize.getWidth();
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    if (!isFirstPage) newPdf.addPage([pdfWidth, pdfHeight]);
                    else isFirstPage = false;

                    newPdf.setPage(i);
                    newPdf.internal.pageSize.width = pdfWidth;
                    newPdf.internal.pageSize.height = pdfHeight;
                    newPdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                }

                state.compressedBlob = newPdf.output('blob');
                showResult();

            } catch (err) {
                console.error(err);
                alert('압축 중 오류가 발생했습니다: ' + err.message);
                resetAll();
            }
        });

        function showResult() {
            const oldSize = state.file.size;
            const newSize = state.compressedBlob.size;
            const ratio = Math.round((1 - (newSize / oldSize)) * 100);
            const isReduced = newSize < oldSize;

            els.progressBar.style.width = '100%';
            els.progressPercent.textContent = '100%';
            
            els.resultActions.classList.remove('hidden');
            
            if (isReduced) {
                els.statusIcon.innerHTML = `<svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                els.processTitle.textContent = "압축 완료!";
                els.processDesc.innerHTML = `<span class="text-gray-400">${formatSize(oldSize)}</span> <span class="text-gray-600 mx-2">→</span> <span class="text-green-400 font-bold text-lg">${formatSize(newSize)}</span> <span class="text-xs bg-green-900 text-green-300 px-2 py-0.5 rounded ml-2">-${ratio}%</span>`;
            } else {
                els.statusIcon.innerHTML = `<svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
                els.processTitle.textContent = "용량 감소 없음";
                els.processDesc.innerHTML = `설정을 '높음'으로 바꾸거나 'DPI'를 낮춰보세요.<br><span class="text-xs text-gray-500">${formatSize(oldSize)} → ${formatSize(newSize)}</span>`;
            }
        }

        function resetAll() {
            state.file = null;
            state.pdfDoc = null;
            state.compressedBlob = null;
            
            els.fileInput.value = '';
            els.uploadView.classList.remove('hidden');
            els.processingView.classList.add('hidden');
            els.fileInfoBar.classList.add('hidden');
            els.compressBtn.textContent = '압축 시작';
            els.compressBtn.disabled = true;
            els.progressBar.style.width = '0%';
        }

        els.resetBtn.addEventListener('click', resetAll);
        els.downloadBtn.addEventListener('click', () => {
            if (!state.compressedBlob) return;
            const link = document.createElement('a');
            link.href = URL.createObjectURL(state.compressedBlob);
            link.download = `compressed_${state.file.name}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

    </script>
</body>

</html>
